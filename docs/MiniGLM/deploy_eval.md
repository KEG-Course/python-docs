# 部署模型与评估

# 模型推理

在本次作业中，我们需要将训练好的模型能够在本地正常运行起来。调试可以通过命令行输出观察模型效果。在进行展示时，要求大家以可视化的界面（网页）进行展示与模型的对话，便于实验的测试与验收。推荐使用 [Gradio](https://www.gradio.app/guides/quickstart) 来进行实现。

# 模型评估

我们将采用以下三方面的指标进行评价模型训练的结果。这些指标旨在高效地指导模型拟合数据分布，同时使人客观地评价模型生成文本的质量。

## 传统指标

* 设置合理的损失函数。在本次实验中，训练损失函数即为单个词预测的交叉熵损失（cross-entropy loss）。

* 困惑度

  * 困惑度（Perlexity）是刻画语言模型预测一个语言文本的能力。在测试集上，困惑度值越低，说明建模的效果越好。
  * 困惑度的计算方式如下：

  $$
  \text{Perlexity(S)} = p(w_1, w_2, w_3, \cdots, w_m)^{-1/m}
  $$

  其中，$m$是句子的长度。

* Rouge-L
  * Rouge是通过将模型生成的回答（Y）与参考答案（X）进行比较计算，得到对应的得分。
  * Rouge-L利用最长公共子序列进行计算，注意子序列不一定连续，但是有词的顺序。
  * Rouge-L的计算方式如下：
  
  $$
  \text{Rouge-L(lcs)} = \frac{(1+\beta^2)R_{lcs}P_{lcs}}{R_{lcs} + \beta^2P_{lcs}}
  $$

  $$
  R_{(lcs)} = \frac{LCS(X, Y)}{m}
  $$

  $$
  P_{(lcs)} = \frac{LCS(X, Y)}{n}
  $$

  其中，$\beta$是超参数句子的长度，m和n各是X和Y的长度。

## 生成速度

* 生成速度正常，评价指标是每秒内生成文本的长度不少于40字。

## 质量评价

* 流畅度：
  * 没有乱码
    * 例如，不会生成类似看不懂的文本，“のて72[UNK]1904屹”。
  * 没有重复内容
    * 例如，不会生成类似“2021等2021等2021等2021等2021等”这样的文本。
  * 没有空白，即回答为空  
* 没有截断，即没有生成完整的一句话
  * 例如，不会生成类似“今天，我们讲 ”这样的文本。
* 相关度，即回答内容与问题相关
  * 例如，不会出现类似样例。即问题是“《倚天屠龙记》有哪些主角？”，答案是“《三国演义》是四大名著之一”。
* 文本：生成有效的最长的文本
  * 正确样例如下：

  ```
  问题是“《倚天屠龙记》有哪些主角？”
  答案是“《倚天屠龙记》是金庸先生所著的武侠小说，主要讲述了元朝末年武林中的故事。这部小说的主角包括：
  1. 张无忌：男主角，明教教主，拥有屠龙刀和倚天剑，是武林中备受关注的人物。  
  2. 赵敏：女主角之一，绍敏郡主，喜欢张无忌，敢爱敢恨，为了爱情可以勇往直前。  
  3. 周芷若：女主角之一，峨嵋派第四代掌门人，张无忌的妻子，与张无忌之间有着深厚的感情纠葛。  
  4. 小昭：女主角之一，明教护教法王黛绮丝之女，喜欢张无忌，最后成为张无忌的义女。  
  此外，还有其他重要角色如谢逊、成昆、杨逍、范遥等。这些人物共同构成了《倚天屠龙记》丰富的故事情节。”。
  ```
