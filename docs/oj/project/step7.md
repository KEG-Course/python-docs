## Step 7：持久化与高可用

---

### 模块目标

实现 OJ 系统核心数据的持久化，支持高可用、断点恢复和数据导出。

---

### 前置知识要求

| 技术点         | 推荐学习内容           |
| -------------- | ---------------------- |
| 数据库操作     | SQLite/ORM             |
| 文件锁/事务    | filelock、事务         |
| REST API 设计  | GET/POST 路由          |

---

### 任务分解

#### 任务 1：数据持久化结构与接口
- 目标：设计用户、评测、题目等核心数据的持久化结构和统一接口。
- 要点：支持 JSON/SQLite 两种后端，字段结构与业务一致。

#### 任务 2：断点恢复与高可用
- 目标：系统启动时自动加载数据，支持断点恢复。
- 要点：所有写操作需加锁，支持多线程/多进程安全。

#### 任务 3：数据导出与备份
- 目标：提供 API 导出/备份所有核心数据。
- 要点：管理员权限，支持 JSON/CSV 格式导出。

---

### 主要 API 设计

#### 1. 数据导出
- 路径：`GET /api/export/`
- 权限：仅管理员
- 参数：
  - `format` (str, 可选): 导出格式（"json"、"csv"），默认 json
- 响应：
```json
{
  "code": 200,
  "msg": "success",
  "data": {
    "users": [...],
    "problems": [...],
    "submissions": [...]
  }
}
```
- 异常：
  - 403 权限不足
  - 500 服务器错误

#### 2. 数据恢复（可选）
- 路径：`POST /api/import/`
- 权限：仅管理员
- 参数：
  - `file` (上传): 数据文件
- 响应：
```json
{
  "code": 200,
  "msg": "import success",
  "data": null
}
```
- 异常：
  - 400 文件格式错误
  - 403 权限不足
  - 500 服务器错误

---

### 状态码与异常
- 详见 [api.md](../api.md)
- 权限不足：403
- 资源不存在：404
- 其他错误：500

---

### 能力小结

| 能力项         | 说明                       |
| -------------- | -------------------------- |
| 数据持久化     | 支持 JSON/SQLite 两种模式  |
| 断点恢复       | 支持高可用与断点恢复       |
| 数据导出/恢复  | 支持管理员导出/恢复数据    |
| 并发安全       | 多线程/多进程安全写入      |

---

**所有 API 需严格遵循 [api.md](../api.md) 规范。**

### 评分细则

| 功能/接口                | 分值 | 评分说明                         |
|--------------------------|------|----------------------------------|
| 数据持久化结构与接口     | 2    | 结构设计、接口一致性              |
| 断点恢复与高可用         | 2    | 启动加载、并发安全                |
| 数据导出接口             | 2    | 权限、格式、响应                  |
| 数据恢复接口             | 1    | 权限、异常、格式                  |
| 文档与实现一致性         | 1    | 文档与实际实现同步                |
| **小计**                 | **8**|                                  |