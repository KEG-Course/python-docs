## Step 3：用户管理

---

### 模块目标

实现用户的注册、信息查询、权限管理、用户列表等功能，支持权限控制和安全校验。

---

### 前置知识要求

| 技术点         | 推荐学习内容           |
| -------------- | ---------------------- |
| 数据结构设计   | 用户表、权限字段       |
| REST API 设计  | GET/POST/PUT 路由      |
| 权限控制       | 用户/管理员区分        |

---

### 任务分解

#### 任务 1：用户注册
- 目标：提供用户注册 API。
- 要点：用户名唯一，注册成功返回用户ID。

#### 任务 2：用户信息查询
- 目标：提供 API 查询用户信息。
- 要点：仅本人或管理员可查，返回用户基本信息和权限。

#### 任务 3：用户权限变更
- 目标：管理员可变更用户权限（如设为 admin/banned）。
- 要点：需校验管理员权限，变更需有日志记录。

#### 任务 4：用户列表查询
- 目标：管理员可查询所有用户列表，支持分页、筛选。
- 要点：可按用户名、角色筛选，支持分页参数。

---

### 主要 API 设计

#### 1. 用户注册
- 路径：`POST /api/users/`
- 参数：
  - `username` (str)
  - `password` (str)
- 响应：
```json
{
  "code": 200,
  "msg": "register success",
  "data": {"user_id": 1}
}
```
- 异常：
  - 400 用户名已存在/参数错误
- 安全说明：密码需加密存储。

#### 2. 查询用户信息
- 路径：`GET /api/users/{user_id}`
- 权限：仅本人或管理员
- 响应：
```json
{
  "code": 200,
  "msg": "success",
  "data": {"user_id": 1, "username": "alice", "role": "user"}
}
```
- 异常：
  - 404 用户不存在
  - 403 权限不足

#### 3. 用户权限变更
- 路径：`PUT /api/users/{user_id}/role`
- 权限：仅管理员
- 参数：
  - `role` (str): 新角色（如 "admin"、"user"、"banned"）
- 响应：
```json
{
  "code": 200,
  "msg": "role updated",
  "data": {"user_id": 1, "role": "admin"}
}
```
- 异常：
  - 404 用户不存在
  - 403 权限不足

#### 4. 用户列表查询
- 路径：`GET /api/users/`
- 权限：仅管理员
- 参数：
  - `username` (str, 可选): 按用户名筛选
  - `role` (str, 可选): 按角色筛选
  - `page` (int, 可选): 页码
  - `page_size` (int, 可选): 每页数量
- 响应：
```json
{
  "code": 200,
  "msg": "success",
  "data": {
    "total": 2,
    "users": [
      {"user_id": 1, "username": "alice", "role": "admin"},
      {"user_id": 2, "username": "bob", "role": "user"}
    ]
  }
}
```
- 异常：
  - 403 权限不足

---

### 状态码与异常
- 详见 [api.md](../api.md)
- 权限不足：403
- 资源不存在：404
- 其他错误：500

---

### 能力小结

| 能力项         | 说明                       |
| -------------- | -------------------------- |
| 用户注册       | 支持唯一用户名注册         |
| 信息查询       | 查询单个/所有用户信息      |
| 权限管理       | 管理员可变更用户权限       |
| 分页筛选       | 用户列表支持分页与筛选     |
| 安全校验       | 密码加密、权限校验         |

---

### 评分细则

| 功能/接口                | 分值 | 评分说明                         |
|--------------------------|------|----------------------------------|
| 用户注册接口             | 2    | 路径、参数、响应、异常            |
| 用户信息查询接口         | 2    | 权限、响应、异常                  |
| 用户权限变更接口         | 2    | 权限、参数、响应、异常            |
| 用户列表查询接口         | 1    | 分页、筛选、权限                  |
| 密码加密与安全说明       | 1    | 密码加密存储、安全性说明          |
| 文档与实现一致性         | 1    | 文档与实际实现同步                |
| **小计**                 | **9**|                                  |