## Step 6：评测日志与调试

---

### 模块目标

实现评测日志的结构化记录、查询、调试模式和日志回放，便于用户和管理员追踪与调试评测过程。

---

### 前置知识要求

| 技术点         | 推荐学习内容           |
| -------------- | ---------------------- |
| 文件操作       | `with open()`、JSONL   |
| REST API 设计  | GET 路由、权限控制     |
| 错误处理       | try/except、状态码     |

---

### 任务分解

#### 任务 1：评测日志结构化记录
- 目标：每次评测后将所有测试点结果写入日志文件。
- 要点：推荐 logs/job_{job_id}.log.jsonl，每行为一条 JSON。

#### 任务 2：日志查询与下载
- 目标：提供 API 查询/下载指定评测的日志。
- 要点：仅本人或管理员可查，日志不存在返回 404。

#### 任务 3：日志回放与调试模式
- 目标：支持结构化回放、debug 模式下返回详细信息。
- 要点：debug=true 时返回更多细节，仅管理员可用。

---

### 主要 API 设计

#### 1. 查询评测日志
- 路径：`GET /api/submissions/{submission_id}/log`
- 权限：仅本人或管理员
- 响应：
```json
{
  "code": 200,
  "msg": "success",
  "data": [
    {"test_id": 1, "status": "Accepted", "input": "1 2", "expected": "3", "actual": "3", "stderr": "", "time": 0.01}
  ]
}
```
- 异常：
  - 404 日志不存在
  - 403 权限不足

#### 2. 日志回放/调试
- 路径：`GET /api/submissions/{submission_id}/replay`
- 参数：
  - `debug` (bool, 可选): 是否开启调试模式
- 权限：仅本人或管理员，debug 仅管理员
- 响应：
```json
{
  "code": 200,
  "msg": "success",
  "data": {
    "steps": [
      {"action": "compile", "result": "success"},
      {"action": "run", "test_id": 1, "status": "Accepted", "output": "3"}
    ],
    "debug_info": {"stderr": "", "memory": 128}
  }
}
```
- 异常：
  - 404 日志不存在
  - 403 权限不足

---

### 状态码与异常
- 详见 [api.md](../api.md)
- 权限不足：403
- 资源不存在：404
- 其他错误：500

---

### 能力小结

| 能力项         | 说明                       |
| -------------- | -------------------------- |
| 日志记录       | 结构化记录所有评测细节     |
| 日志查询       | 支持用户/管理员权限查询     |
| 调试模式       | debug 模式下返回更多细节   |
| 日志回放       | 支持结构化回放与可视化     |

---

**所有 API 需严格遵循 [api.md](../api.md) 规范。**

### 评分细则

| 功能/接口                | 分值 | 评分说明                         |
|--------------------------|------|----------------------------------|
| 日志结构化记录           | 2    | 结构化日志、字段完整              |
| 日志查询接口             | 2    | 权限、响应、异常                  |
| 日志回放/调试接口        | 2    | debug 模式、权限、异常            |
| 文档与实现一致性         | 1    | 文档与实际实现同步                |
| **小计**                 | **7**|                                  |