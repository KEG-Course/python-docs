## Step 4：任务状态管理

---

### 模块目标

实现评测任务的标准生命周期管理、调度与状态流转。

---

### 前置知识要求

| 技术点         | 推荐学习内容           |
| -------------- | ---------------------- |
| 枚举 Enum      | Python `enum.Enum` 定义状态 |
| 多线程与锁机制 | `threading.Thread` + `threading.Lock` |
| 数据结构设计   | 字典、列表、优先级队列管理任务 |
| RESTful API    | GET/PUT/DELETE 路由设计 |
| 时间处理       | `datetime` 获取/格式化时间 |

---

### 任务拆解

#### 任务 1：任务结构与状态流转
- 目标：设计任务对象及标准状态流转。
- 要点：任务状态建议用枚举，字段包括id、user_id、problem_id、status、result、score、时间等。
- 建议：优先级字段继承自用户角色，状态只能按合法流程流转。

#### 任务 2：任务调度与API
- 目标：后台线程自动调度队列中的任务，支持任务的增删查改与重评。
- 要点：新任务入队，调度线程取队首任务执行，评测结束更新状态，API支持分页、筛选、排序。
- 建议：重评需验证终态，删除支持逻辑删除。

#### 任务 3：任务状态流转控制
- 目标：任务状态只能按合法流程流转。
- 要点：Pending→Running→终态，非终态禁止重评，管理员可人工通过。
- 建议：用mermaid图或表格明确流转规则。

#### 任务 4：支持任务优先级与队列可见性
- 目标：任务优先级调度，队列可见。
- 要点：优先级继承自用户角色，支持队列查询接口。
- 建议：接口返回当前排队任务列表。

---

### 能力小结

| 能力项         | 说明                       |
| -------------- | -------------------------- |
| 任务建模       | 结构清晰，含状态、分数、时间、用户等 |
| 状态控制       | 状态只能按合法流转         |
| API能力        | 支持任务创建、查询、删除、重评等 |
| 调度能力       | 支持优先级队列与并发调度   |
| 权限管理       | 普通用户/管理员权限分离     |