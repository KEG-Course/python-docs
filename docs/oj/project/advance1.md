## Advance 1：Special Judge（特判）

---

### 什么是 Special Judge（SPJ）？

Special Judge（简称 SPJ，特判）是一种自定义评测方式。当题目的标准答案无法用简单的"输出与标准输出完全一致"来判定对错时，需要用 SPJ 脚本来判断用户输出是否正确。

**常见场景：**
- 输出顺序可以不同但内容正确（如集合、浮点数误差、输出格式灵活等）
- 多解题目（如输出任意一组可行解）
- 需要自定义判分规则（如部分得分、输出合法性等）

**SPJ 的作用：**
- 由管理员上传自定义判题脚本，自动对用户输出和标准输出进行比对，返回通过/未通过或得分。
- 评测时自动调用 SPJ 脚本，替代默认的"逐字符比对"。

**与普通评测的区别：**
- 普通评测：只要输出和标准输出完全一致即通过。
- SPJ 评测：由自定义脚本决定是否通过，可以更灵活地判定正确性。

---

### 模块目标

支持多种评测方式，允许题目配置选择评测策略，支持上传/管理 SPJ 脚本。

---

### 前置知识要求

| 技术点         | 推荐学习内容           |
| -------------- | ---------------------- |
| 评测策略设计   | 枚举、配置文件         |
| 文件上传       | FastAPI/Flask 文件上传 |
| 安全执行       | 沙箱、权限校验         |

---

### 任务分解

#### 任务 1：题目配置支持评测策略
- 目标：题目配置文件支持 standard/strict/special judge 等多种评测方式。
- 要点：配置文件中增加 `judge_mode` 字段。

#### 任务 2：上传/管理 SPJ 脚本
- 目标：管理员可上传/更新/删除 SPJ 脚本。
- 要点：需校验脚本安全性，仅管理员可操作。

#### 任务 3：评测时自动选择评测策略
- 目标：评测时根据题目配置自动选择评测方式。
- 要点：SPJ 需在沙箱中安全执行。

---

### 主要 API 设计

#### 1. 上传 SPJ 脚本
- 路径：`POST /api/problems/{problem_id}/spj`
- 权限：仅管理员
- 参数：
  - `file` (上传): SPJ 脚本文件
- 响应：
```json
{
  "code": 200,
  "msg": "spj uploaded",
  "data": null
}
```
- 异常：
  - 400 文件格式错误
  - 403 权限不足

#### 2. 删除 SPJ 脚本
- 路径：`DELETE /api/problems/{problem_id}/spj`
- 权限：仅管理员
- 响应：
```json
{
  "code": 200,
  "msg": "spj deleted",
  "data": null
}
```
- 异常：
  - 404 SPJ 不存在
  - 403 权限不足

#### 3. 查询题目评测策略
- 路径：`GET /api/problems/{problem_id}`
- 响应：
```json
{
  "code": 200,
  "msg": "success",
  "data": {
    "problem_id": 1001,
    "judge_mode": "special",
    "spj_exists": true
  }
}
```
- 异常：
  - 404 题目不存在

---

### 状态码与异常
- 详见 [api.md](../api.md)
- 权限不足：403
- 资源不存在：404
- 其他错误：500

---

### 能力小结

| 能力项         | 说明                       |
| -------------- | -------------------------- |
| 多评测方式     | 支持 standard/strict/special judge |
| SPJ 管理       | 支持上传/删除 SPJ 脚本     |
| 策略自动选择   | 评测时自动选择评测方式     |
| 安全执行       | SPJ 脚本沙箱安全运行       |

---

**所有 API 需严格遵循 [api.md](../api.md) 规范。**

### 评分细则

| 功能/接口                | 分值 | 评分说明                         |
|--------------------------|------|----------------------------------|
| 题目评测策略配置         | 1    | 配置文件 judge_mode 字段           |
| SPJ 上传/删除接口        | 2    | 路径、权限、安全、异常            |
| 评测策略自动选择         | 1    | 评测流程自动切换                  |
| SPJ 沙箱安全执行         | 1    | 沙箱说明、执行安全                |
| 文档与实现一致性         | 1    | 文档与实际实现同步                |
| **小计**                 | **6**|                                  | 