## Advance 4：查重系统

---

### 什么是查重系统？

查重系统用于检测不同用户提交的代码之间的相似度，防止抄袭和作弊。OJ 查重不仅要能检测文本相似，还要能适应变量名变化、代码结构调整等常见"伪装"抄袭。

---

### 模块目标

- 实现代码查重与抄袭检测系统，支持多种查重算法的实现与选择。
- 支持查重检测、结果查询、报告下载等功能。
- 强调查重方式的可扩展性和算法对比。

---

### 前置知识要求

| 技术点         | 推荐学习内容           |
| -------------- | ---------------------- |
| 代码相似度算法 | 文本对比、AST、指纹算法、编辑距离等 |
| 文件操作       | Python 文件读写        |
| REST API 设计  | GET/POST 路由          |

---

### 任务分解

#### 任务 1：实现多种查重算法
- 目标：实现至少两种不同的查重方式（如文本相似度、AST 结构、指纹算法等）。
- 要点：每种算法需有独立实现，能对比不同算法的查重效果。
- 建议：可先实现简单的文本对比，再实现更鲁棒的结构化查重。

#### 任务 2：查重检测与算法选择
- 目标：管理员可发起查重检测，并选择使用哪种查重算法。
- 要点：API 支持指定算法参数，查重结果结构化保存。

#### 任务 3：查重结果查询与报告下载
- 目标：支持查询查重结果、下载查重报告（如 PDF/CSV）。
- 要点：仅管理员可操作，报告需包含相似度对比明细。

---

### 基于 AST 的结构化查重算法

本模块要求实现基于抽象语法树（Abstract Syntax Tree, AST）的代码结构相似度比较算法。该算法通过分析代码的语法结构而非文本表示，能有效识别经过变量重命名、语句重排等转换的抄袭代码。

#### 算法原理

1. **AST 生成**：将源代码解析为抽象语法树，每个节点代表一个语法结构（如函数定义、循环语句、条件分支等）。

2. **树结构标准化**：
   - 规范化变量名（如将所有变量替换为 VAR_1, VAR_2）
   - 规范化字面量（如将具体数值替换为 NUM）
   - 保留控制流结构（如 if-else, for, while 等）

3. **子树特征提取**：
   - 对 AST 进行后序遍历
   - 为每个子树生成特征向量
   - 记录子树的结构特征（如深度、节点类型分布等）

4. **相似度计算**：
   - 使用带权重的树编辑距离（Tree Edit Distance）
   - 考虑节点类型的重要性权重
   - 归一化处理得到 [0,1] 范围的相似度

#### 实现要点

1. 使用 Python 的 `ast` 模块解析源代码
2. 实现树结构的标准化转换
3. 设计合理的特征提取方案
4. 实现高效的树编辑距离算法

> 该算法的难点在于树结构的标准化处理和编辑距离的高效计算，但其对变量重命名、语句重排等常见抄袭手段具有很强的识别能力。

---

### 主要 API 设计

- 发起查重检测：`POST /api/plagiarism/`（支持选择算法）
- 查询查重结果：`GET /api/plagiarism/{task_id}`
- 下载查重报告：`GET /api/plagiarism/{task_id}/report`

---

### 能力小结

| 能力项         | 说明                       |
| -------------- | -------------------------- |
| 查重算法实现   | 至少实现两种查重方式       |
| 算法选择与对比 | 支持多算法选择与效果对比   |
| 结果查询       | 支持结构化查重结果查询     |
| 报告下载       | 支持多格式查重报告下载     |
| 权限控制       | 仅管理员可操作             |

---

**所有 API 需严格遵循 [api.md](../api.md) 规范。**

---

### 评分细则

| 功能/接口                | 分值 | 评分说明                         |
|--------------------------|------|----------------------------------|
| 查重算法实现             | 2    | 至少两种查重方式，代码结构清晰    |
| 算法选择与参数           | 1    | 支持查重算法选择与参数传递        |
| 查重结果与报告           | 2    | 结果结构化、报告可下载            |
| 权限与安全说明           | 1    | 仅管理员、接口安全                |
| 文档与实现一致性         | 1    | 文档与实际实现同步                |
| **小计**                 | **7**|                                  |

> 完成本模块后，你将能实现多种查重算法，支持管理员发起查重、选择算法、查询结果和下载报告，具备对抄袭行为的有效检测能力。